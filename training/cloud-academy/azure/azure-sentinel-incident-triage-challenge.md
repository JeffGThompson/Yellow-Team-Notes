---
description: >-
  Challenge to setup Azure Sentinel, collect logs from a Virtual Machine(VM),
  create a basic analytics rule and have the rule trigger.
---

# Azure Sentinel Incident Triage Challenge

## **Walkthrough**

**Create an Azure Sentinel Workspace**

Create an Azure Sentinel resource using the existing Log Analytics workspace.

* Must use the existing workspace **calabws**

Head over to Microsoft Sentinel and create it.

<figure><img src="../../../.gitbook/assets/image (20).png" alt=""><figcaption></figcaption></figure>

****

Make sure you have the calabws workspace selected.

<figure><img src="../../../.gitbook/assets/image (19).png" alt=""><figcaption></figcaption></figure>

****

**Create a Data Collection Rule in Sentinel**

Create a Data Collection Rule to collect Security Events from the Azure VM

* Collection Rule name must be _windows-event_
* Add the Azure VM **ca-lab-vm** to the data collection rule scope
* The data collection must collect at least **Common** event stream



First we need to head over to the Log Analytics workspace and make sure that the VM is able to send logs to our workspace.

<figure><img src="../../../.gitbook/assets/image (12) (1).png" alt=""><figcaption></figcaption></figure>



![](<../../../.gitbook/assets/image (6) (1).png>)



Shortly after you should see that the VM has connected to the workspace.

<figure><img src="../../../.gitbook/assets/image (10) (1).png" alt=""><figcaption></figcaption></figure>

Now we start creating our collection rule within Sentinel. Head back to Microsoft Sentinel. Click the data connectors and add Windows Security Events via AMA.



<figure><img src="../../../.gitbook/assets/image (16) (1).png" alt=""><figcaption></figcaption></figure>

Add the rule name windows-event.

<figure><img src="../../../.gitbook/assets/image (22).png" alt=""><figcaption></figcaption></figure>



Add the VM we added to the Log Analytics workspace.



<figure><img src="../../../.gitbook/assets/image (2) (1).png" alt=""><figcaption></figcaption></figure>



<figure><img src="../../../.gitbook/assets/image (7) (1).png" alt=""><figcaption></figcaption></figure>



<figure><img src="../../../.gitbook/assets/image (15).png" alt=""><figcaption></figcaption></figure>

Make sure we have Common selected.

<figure><img src="../../../.gitbook/assets/image (25).png" alt=""><figcaption></figcaption></figure>





<figure><img src="../../../.gitbook/assets/image (9) (1).png" alt=""><figcaption></figcaption></figure>



**Create an Analytics Rule to Run Scheduled Queries**

Create an Analytics Rule to Run Scheduled Queries that satisfies the following:

* The rule severity should be **Medium**
* Query schedule should be set to run 5 minutes
* The log inspection script must check for EventID 4625 to report failed logins
* Use the query `SecurityEvent | where EventID == 4625`
* Try RDP access into the Azure VM by supplying an incorrect password to generate events&#x20;



We're going to generate our logs first instead of later on so we can see the rule working before we create it.

<figure><img src="../../../.gitbook/assets/image (8) (1).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (3) (1) (1).png" alt=""><figcaption></figcaption></figure>





Enter incorrect credentials a few times to create logs.

<figure><img src="../../../.gitbook/assets/image (11) (1).png" alt=""><figcaption></figcaption></figure>

Now we can start creating our Analytics rule.

<figure><img src="../../../.gitbook/assets/image (4) (1) (1).png" alt=""><figcaption></figcaption></figure>





<figure><img src="../../../.gitbook/assets/image (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

****

<figure><img src="../../../.gitbook/assets/image (23).png" alt=""><figcaption></figcaption></figure>

****

<figure><img src="../../../.gitbook/assets/image (7).png" alt=""><figcaption></figcaption></figure>

Make sure alert threshold is greater than 0 so it fires if any hits happen.

<figure><img src="../../../.gitbook/assets/image (14).png" alt=""><figcaption></figcaption></figure>

Leave default settings.

<figure><img src="../../../.gitbook/assets/image (17).png" alt=""><figcaption></figcaption></figure>

****

Leave default settings.

<figure><img src="../../../.gitbook/assets/image (13) (1).png" alt=""><figcaption></figcaption></figure>

****

Click Create.

<figure><img src="../../../.gitbook/assets/image (24).png" alt=""><figcaption></figcaption></figure>

****

**Triage and Close At Lease One Incident**

Close at least one incident from the Sentinel Incidents Dashboard

* Ensure that you try RDP access into Azure VM using an incorrect password
* Wait for about 5 minutes for the analytics rule to run and analyze the data
* Close at least one of the incidents generated by analytics rule



After a few minutes we can see an incident was created. Nothing left to do except close the incident.&#x20;

<figure><img src="../../../.gitbook/assets/image (5).png" alt=""><figcaption></figcaption></figure>





<figure><img src="../../../.gitbook/assets/image (21).png" alt=""><figcaption></figcaption></figure>

